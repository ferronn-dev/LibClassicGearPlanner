-- This table is autogenerated. Do not manually edit.
local enchantTable = {
  [1] = {
    [1483] = 15340,
    [1503] = 15389,
    [1504] = 15391,
    [1505] = 15394,
    [1506] = 15397,
    [1507] = 15400,
    [1508] = 15402,
    [1509] = 15404,
    [1510] = 15406,
    [2543] = 22840,
    [2544] = 22844,
    [2545] = 22846,
    [2583] = 24149,
    [2584] = 24160,
    [2585] = 24161,
    [2586] = 24162,
    [2587] = 24163,
    [2588] = 24164,
    [2589] = 24165,
    [2590] = 24167,
    [2591] = 24168,
    [2681] = 28161,
    [2682] = 28163,
    [2683] = 28165,
  },
  [3] = {
    [2483] = 22593,
    [2484] = 22594,
    [2485] = 22598,
    [2486] = 22597,
    [2487] = 22596,
    [2488] = 22599,
    [2604] = 24420,
    [2605] = 24421,
    [2606] = 24422,
    [2715] = 29475,
    [2716] = 29480,
    [2717] = 29483,
    [2721] = 29467,
  },
  [5] = {
    [15] = 2831,
    [16] = 2832,
    [17] = 2833,
    [18] = 10344,
    [24] = 7443,
    [41] = 7420,
    [44] = 7426,
    [63] = 13538,
    [242] = 7748,
    [246] = 7776,
    [254] = 7857,
    [843] = 13607,
    [847] = 13626,
    [850] = 13640,
    [857] = 13663,
    [866] = 13700,
    [908] = 13858,
    [913] = 13917,
    [928] = 13941,
    [1843] = 19057,
    [1891] = 20025,
    [1892] = 20026,
    [1893] = 20028,
    [2503] = 22725,
  },
  [7] = {
    [15] = 2831,
    [16] = 2832,
    [17] = 2833,
    [18] = 10344,
    [1483] = 15340,
    [1503] = 15389,
    [1504] = 15391,
    [1505] = 15394,
    [1506] = 15397,
    [1507] = 15400,
    [1508] = 15402,
    [1509] = 15404,
    [1510] = 15406,
    [1523] = 15427,
    [1524] = 15429,
    [1525] = 15439,
    [1526] = 15441,
    [1527] = 15444,
    [1528] = 15446,
    [1529] = 15449,
    [1530] = 15458,
    [1532] = 15463,
    [1543] = 15490,
    [1843] = 19057,
    [2503] = 22725,
    [2543] = 22840,
    [2544] = 22844,
    [2545] = 22846,
    [2583] = 24149,
    [2584] = 24160,
    [2585] = 24161,
    [2586] = 24162,
    [2587] = 24163,
    [2588] = 24164,
    [2589] = 24165,
    [2590] = 24167,
    [2591] = 24168,
    [2681] = 28161,
    [2682] = 28163,
    [2683] = 28165,
  },
  [8] = {
    [15] = 2831,
    [16] = 2832,
    [17] = 2833,
    [18] = 10344,
    [66] = 7863,
    [247] = 7867,
    [255] = 13687,
    [464] = 9783,
    [724] = 13644,
    [849] = 13637,
    [851] = 20024,
    [852] = 13836,
    [904] = 13935,
    [911] = 13890,
    [929] = 20020,
    [1843] = 19057,
    [1887] = 20023,
    [2503] = 22725,
  },
  [9] = {
    [41] = 7418,
    [66] = 7457,
    [243] = 7766,
    [247] = 7779,
    [248] = 7782,
    [255] = 7859,
    [723] = 13622,
    [724] = 13501,
    [823] = 13536,
    [851] = 13642,
    [852] = 13648,
    [856] = 13661,
    [905] = 13822,
    [907] = 13846,
    [923] = 13931,
    [924] = 7428,
    [925] = 13646,
    [927] = 13939,
    [929] = 13945,
    [1883] = 20008,
    [1884] = 20009,
    [1885] = 20010,
    [1886] = 20011,
    [2565] = 23801,
    [2566] = 23802,
  },
  [10] = {
    [15] = 2831,
    [16] = 2832,
    [17] = 2833,
    [18] = 10344,
    [844] = 13612,
    [845] = 13617,
    [846] = 13620,
    [856] = 13887,
    [865] = 13698,
    [904] = 13815,
    [906] = 13841,
    [909] = 13868,
    [927] = 20013,
    [930] = 13947,
    [931] = 13948,
    [1843] = 19057,
    [1887] = 20012,
    [2503] = 22725,
    [2564] = 25080,
    [2613] = 25072,
    [2614] = 25073,
    [2615] = 25074,
    [2616] = 25078,
    [2617] = 25079,
  },
  [14] = {
    [255] = 13485,
    [848] = 13464,
  },
  [16] = {
    [65] = 7454,
    [247] = 13419,
    [256] = 7861,
    [744] = 13421,
    [783] = 7771,
    [804] = 13522,
    [848] = 13635,
    [849] = 13882,
    [884] = 13746,
    [903] = 13794,
    [910] = 25083,
    [1888] = 20014,
    [1889] = 20015,
    [2463] = 13657,
    [2619] = 25081,
    [2620] = 25082,
    [2621] = 25084,
    [2622] = 25086,
  },
}

local LibBase64 = LibStub:GetLibrary('LibBase64-1.0')

local function getTalentBytes()
  local t = ''
  for i = 1, GetNumTalentTabs() do
    for j = 1, GetNumTalents(i) do
      local count = select(5, GetTalentInfo(i, j))
      t = t .. string.char(count)
    end
    t = t:gsub('%z*$', '') .. '\15'
  end
  local r = ''
  for i = 1, t:len(), 2 do
    local hi = t:sub(i, i):byte()
    local lo = i ~= t:len() and t:sub(i + 1, i + 1):byte() or 0
    r = r .. string.char(hi * 16 + lo)
  end
  return r
end

local function pack16(n)
  return string.char(math.floor(n / 256)) .. string.char(math.fmod(n, 256))
end

local function getInventoryBytes()
  local r = ''
  for slot = 1, 18 do
    if slot ~= 4 then
      local link = GetInventoryItemLink('player', slot)
      if link then
        local _, id, ench, _, _, _, _, rand = strsplit(':', link)
        local sb = slot
        local b = ''
        if ench ~= '' then
          sb = sb + 128
          b = b .. pack16(enchantTable[slot][tonumber(ench)])
        end
        if rand ~= '' then
          sb = sb + 64
          b = b .. pack16(tonumber(rand))
        end
        r = r .. string.char(sb) .. pack16(tonumber(id)) .. b
      end
    end
  end
  return r
end

local function gearPlannerUrl()
  local talentBytes = getTalentBytes()
  return ('https://classic.wowhead.com/gear-planner/'
     .. UnitClassBase('player'):lower()
     .. '/'
     .. UnitRace('player'):lower():gsub(' ', '-')
     .. '/'
     .. LibBase64.Encode('\002'
         .. string.char(UnitLevel('player'))
         .. string.char(talentBytes:len())
         .. talentBytes
         .. getInventoryBytes()
         .. ''):gsub('=', ''):gsub('/', '_'):gsub('+', '-'))
end

local lib = LibStub:NewLibrary('LibClassicGearPlanner', 1)
if lib then
  lib.GenerateUrl = gearPlannerUrl
end
